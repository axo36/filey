<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FILEY - T√©l√©porteur</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0e27;
            color: #00d4ff;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 40px;
        }

        .btn-back {
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-back:hover {
            background: #00d4ff;
            color: #0a0e27;
        }

        h1 {
            text-align: center;
            font-size: 4em;
            color: #00d4ff;
            letter-spacing: 8px;
            text-shadow: 0 0 20px #00d4ff;
            flex: 1;
        }

        .teleporter-info {
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            background: rgba(0, 212, 255, 0.03);
            text-align: center;
        }

        .teleporter-name {
            font-size: 2em;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .target-codes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .code-badge {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1em;
        }

        .main-box {
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            background: rgba(0, 212, 255, 0.03);
        }

        .section-box {
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            background: rgba(0, 212, 255, 0.02);
        }

        .section-title {
            color: #00d4ff;
            font-size: 1.3em;
            text-align: center;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .drop-zone {
            border: 2px dashed #00d4ff;
            border-radius: 8px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0, 212, 255, 0.01);
        }

        .drop-zone:hover {
            background: rgba(0, 212, 255, 0.08);
        }

        .drop-zone input {
            display: none;
        }

        .drop-text {
            color: #00d4ff;
            font-size: 1.1em;
        }

        .files-container,
        .execution-file-container {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 212, 255, 0.05);
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #00d4ff;
        }

        .file-item-name {
            color: #00d4ff;
            font-size: 1em;
            flex: 1;
        }

        .btn-remove {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0 5px;
            transition: all 0.3s;
        }

        .btn-remove:hover {
            color: #ff0000;
            font-weight: bold;
        }

        .path-section {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #00d4ff;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 0.8em;
        }

        .checkbox-custom:hover {
            box-shadow: 0 0 10px #00d4ff;
        }

        .checkbox-custom.checked {
            background: #00d4ff;
            color: #0a0e27;
            font-weight: bold;
        }

        .checkbox-label {
            color: #00d4ff;
            font-size: 1.1em;
            cursor: pointer;
            user-select: none;
        }

        .path-input-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .path-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            border-radius: 5px;
            font-size: 1em;
        }

        .path-input:focus {
            outline: none;
            box-shadow: 0 0 10px #00d4ff;
        }

        .path-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-browse {
            padding: 12px 20px;
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1.3em;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-browse:hover:not(:disabled) {
            background: #00d4ff;
            color: #0a0e27;
            box-shadow: 0 0 15px #00d4ff;
        }

        .btn-browse:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-valider {
            padding: 12px 35px;
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        .btn-valider:hover {
            background: #00d4ff;
            color: #0a0e27;
            box-shadow: 0 0 20px #00d4ff;
        }

        .history-box {
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 40px;
            background: rgba(0, 212, 255, 0.03);
        }

        .history-title {
            color: #00d4ff;
            font-size: 1.3em;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }

        .history-items {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.02);
            border-left: 3px solid #00d4ff;
            border-radius: 5px;
            position: relative;
        }

        .folder-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            min-width: 100px;
        }

        .folder-icon {
            font-size: 3.5em;
            min-width: 80px;
            text-align: center;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            color: #00d4ff;
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .execution-info {
            color: #00a8cc;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .destination-info {
            color: #00a8cc;
            font-size: 0.85em;
        }

        .target-code-info {
            color: #10b981;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message {
            margin-top: 10px;
            padding: 10px 15px;
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid #ff6b6b;
            border-radius: 5px;
            color: #ff6b6b;
            font-size: 0.9em;
        }

        .status-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }

        .status-line {
            color: #f59e0b;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-line.success {
            color: #10b981;
        }

        .status-line.pending {
            color: #f59e0b;
        }

        .status-line.error {
            color: #ff6b6b;
        }

        .btn-delete-file {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.3s;
        }

        .btn-delete-file:hover {
            color: #ff0000;
            font-weight: bold;
        }

        .empty {
            text-align: center;
            color: #00a8cc;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="menu.html" class="btn-back">‚Üê retour</a>
            <h1>FILEY</h1>
        </div>

        <div class="teleporter-info">
            <div class="teleporter-name" id="teleporterName">T√©l√©porteur</div>
            <div style="font-size: 1.2em; color: #00a8cc;">Codes cibles :</div>
            <div class="target-codes" id="targetCodes"></div>
        </div>
        
        <div class="main-box">
            <!-- DEPOSER FICHIER -->
            <div class="section-box">
                <div class="section-title">D√©poser un fichier</div>
                <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" multiple>
                    <div class="drop-text">Glisse des fichiers ici ou clique</div>
                </div>
                <div id="filesContainer" class="files-container"></div>
            </div>
            
            <!-- CHOISIR FICHIER A EXECUTER -->
            <div class="section-box">
                <div class="section-title">Choisir le fichier √† ex√©cuter</div>
                <div class="drop-zone" onclick="document.getElementById('fileToExecuteInput').click()">
                    <input type="file" id="fileToExecuteInput">
                    <div class="drop-text">Glisse un fichier ici ou clique</div>
                </div>
                <div id="executionFileContainer" class="execution-file-container"></div>
            </div>
            
            <!-- CREER UN DOSSIER PERSONNALISE -->
            <div class="section-box">
                <div class="path-section">
                    <div class="checkbox-group">
                        <div class="checkbox-custom" id="folderCheckbox" onclick="toggleFolderCheckbox()"></div>
                        <label class="checkbox-label" onclick="toggleFolderCheckbox()">Cr√©er dans un dossier</label>
                    </div>
                    <div class="path-input-container">
                        <input type="text" class="path-input" id="folderName" placeholder="Nom du dossier" disabled>
                    </div>
                </div>
            </div>
            
            <!-- CHEMIN TELEPORTATION -->
            <div class="section-box">
                <div class="path-section">
                    <div class="checkbox-group">
                        <div class="checkbox-custom" id="checkbox" onclick="toggleCheckbox()"></div>
                        <label class="checkbox-label" onclick="toggleCheckbox()">Chemin de t√©l√©portation</label>
                    </div>
                    <div class="path-input-container">
                        <input type="text" class="path-input" id="filepath" placeholder="Cliquez sur üóÇÔ∏è pour parcourir" disabled>
                        <button class="btn-browse" id="browseBtn" onclick="openExplorer()" disabled title="Ouvrir l'explorateur">üóÇÔ∏è</button>
                        <button class="btn-valider" onclick="validerTeleportation()">Valider</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HISTORIQUE -->
        <div class="history-box">
            <div class="history-title">üìÇ Historique</div>
            <div id="historyContainer" class="history-items">
                <div class="empty">Aucun fichier pour l'instant</div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG SUPABASE
        const SUPABASE_URL = "https://tjiqssgrxvxnjqhewtrt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_IUb-C1nf11c98QajH_MTVw_8ZQGhMWp";
        const STORAGE_BUCKET = "files";
        const JOBS_TABLE = "teleporter_jobs";
        const STORAGE_URL = `${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}`;
        const JOBS_URL = `${SUPABASE_URL}/rest/v1/${JOBS_TABLE}`;

        // RECUPERER PARAMETRES URL
        const urlParams = new URLSearchParams(window.location.search);
        const teleporterId = urlParams.get('id');
        const teleporterName = decodeURIComponent(urlParams.get('name') || 'T√©l√©porteur');
        const targetCodes = JSON.parse(decodeURIComponent(urlParams.get('codes') || '[]'));

        document.getElementById('teleporterName').textContent = teleporterName;
        document.getElementById('targetCodes').innerHTML = targetCodes.map(code => 
            `<span class="code-badge">${code}</span>`
        ).join('');

        // VARIABLES
        let selectedFiles = [];
        let fileToExecute = null;
        let checkboxChecked = false;
        let folderCheckboxChecked = false;

        // GESTION FICHIERS √Ä D√âPOSER
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            selectedFiles = [...selectedFiles, ...newFiles];
            updateFilesDisplay();
        });

        function updateFilesDisplay() {
            const container = document.getElementById('filesContainer');
            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <span class="file-item-name">üìÑ ${file.name}</span>
                    <button class="btn-remove" onclick="removeFile(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilesDisplay();
        }

        // GESTION FICHIER √Ä EX√âCUTER
        document.getElementById('fileToExecuteInput').addEventListener('change', function(e) {
            fileToExecute = e.target.files[0];
            updateExecutionFileDisplay();
        });

        function updateExecutionFileDisplay() {
            const container = document.getElementById('executionFileContainer');
            if (!fileToExecute) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `
                <div class="file-item">
                    <span class="file-item-name">‚öôÔ∏è ${fileToExecute.name}</span>
                    <button class="btn-remove" onclick="removeExecutionFile()">‚úï</button>
                </div>
            `;
        }

        function removeExecutionFile() {
            fileToExecute = null;
            document.getElementById('fileToExecuteInput').value = '';
            updateExecutionFileDisplay();
        }

        // CHECKBOX DOSSIER
        function toggleFolderCheckbox() {
            folderCheckboxChecked = !folderCheckboxChecked;
            const checkbox = document.getElementById('folderCheckbox');
            const folderName = document.getElementById('folderName');
            
            if (folderCheckboxChecked) {
                checkbox.classList.add('checked');
                checkbox.textContent = '‚úì';
                folderName.disabled = false;
                folderName.focus();
            } else {
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
                folderName.disabled = true;
                folderName.value = '';
            }
        }

        // CHECKBOX CHEMIN
        function toggleCheckbox() {
            checkboxChecked = !checkboxChecked;
            const checkbox = document.getElementById('checkbox');
            const filepath = document.getElementById('filepath');
            const browseBtn = document.getElementById('browseBtn');
            
            if (checkboxChecked) {
                checkbox.classList.add('checked');
                checkbox.textContent = '‚úì';
                filepath.disabled = false;
                browseBtn.disabled = false;
            } else {
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
                filepath.disabled = true;
                browseBtn.disabled = true;
                filepath.value = '';
            }
        }

        // OUVRIR EXPLORATEUR
        function openExplorer() {
            window.open('explorer.html', 'FileyExplorer', 'width=900,height=700,resizable=yes,scrollbars=yes');
        }

        // UPLOAD FICHIER
        async function uploadFileToStorage(file) {
            const timestamp = Date.now();
            const cleanName = file.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9._-]/g, '');
            const filename = `${timestamp}_${cleanName}`;
            
            try {
                const response = await fetch(`${STORAGE_URL}/${filename}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'apikey': SUPABASE_KEY
                    },
                    body: file
                });

                if (!response.ok) return null;

                return `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${filename}`;
            } catch (error) {
                console.error("Erreur upload:", error);
                return null;
            }
        }

        // VALIDER ET ENVOYER
        async function validerTeleportation() {
            if (selectedFiles.length === 0) {
                alert('S√©lectionnez au moins un fichier');
                return;
            }
            if (!fileToExecute) {
                alert('S√©lectionnez un fichier √† ex√©cuter');
                return;
            }
            if (checkboxChecked && !document.getElementById('filepath').value.trim()) {
                alert('S√©lectionnez un chemin de t√©l√©portation');
                return;
            }
            if (folderCheckboxChecked && !document.getElementById('folderName').value.trim()) {
                alert('Entrez un nom de dossier');
                return;
            }

            const filepath = checkboxChecked ? document.getElementById('filepath').value.trim() : '';
            const customFolder = folderCheckboxChecked ? document.getElementById('folderName').value.trim() : '';

            const executeFileURL = await uploadFileToStorage(fileToExecute);
            if (!executeFileURL) {
                alert("Erreur lors de l'upload du fichier √† ex√©cuter");
                return;
            }

            for (let file of selectedFiles) {
                const fileURL = await uploadFileToStorage(file);
                
                if (!fileURL) {
                    alert(`Erreur lors de l'upload de ${file.name}`);
                    continue;
                }

                // ENVOYER POUR CHAQUE CODE CIBLE
                for (let code of targetCodes) {
                    const data = {
                        teleporter_id: teleporterId,
                        teleporter_name: teleporterName,
                        target_code: code,
                        filename: file.name,
                        file_url: fileURL,
                        file_to_execute: fileToExecute.name,
                        execute_file_url: executeFileURL,
                        destination: filepath || null,
                        custom_folder: customFolder || null,
                        status: "en_attente"
                    };

                    try {
                        await fetch(JOBS_URL, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${SUPABASE_KEY}`,
                                "apikey": SUPABASE_KEY
                            },
                            body: JSON.stringify(data)
                        });
                    } catch (error) {
                        console.error("Erreur:", error);
                    }
                }
            }

            setTimeout(() => {
                document.getElementById('filepath').value = '';
                document.getElementById('folderName').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileToExecuteInput').value = '';
                selectedFiles = [];
                fileToExecute = null;
                
                if (checkboxChecked) toggleCheckbox();
                if (folderCheckboxChecked) toggleFolderCheckbox();
                
                updateFilesDisplay();
                updateExecutionFileDisplay();
                loadHistory();
                alert('‚úÖ Fichiers envoy√©s avec succ√®s !');
            }, 500);
        }

        // CHARGER HISTORIQUE
        async function loadHistory() {
            try {
                const response = await fetch(JOBS_URL + `?teleporter_id=eq.${teleporterId}&order=id.desc`, {
                    headers: {
                        "Authorization": `Bearer ${SUPABASE_KEY}`,
                        "apikey": SUPABASE_KEY
                    }
                });

                const data = await response.json();
                displayHistory(data);
            } catch (error) {
                console.error("Erreur historique:", error);
            }
        }

        function displayHistory(jobs) {
            const container = document.getElementById('historyContainer');
            
            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<div class="empty">Aucun fichier</div>';
                return;
            }

            const items = jobs.map(d => {
                if (!d) return '';
                
                const hasDestination = d.destination && d.destination.trim() !== '';
                const hasCustomFolder = d.custom_folder && d.custom_folder.trim() !== '';
                
                let fullPath = '';
                if (hasCustomFolder && !hasDestination) {
                    fullPath = d.custom_folder;
                } else if (hasDestination && !hasCustomFolder) {
                    fullPath = d.destination;
                } else if (hasDestination && hasCustomFolder) {
                    fullPath = `${d.destination}\\${d.custom_folder}`;
                } else {
                    fullPath = 'Downloads\\FILEY';
                }
                
                const status = d.status || 'en_attente';
                const hasError = d.error_message && d.error_message.trim() !== '';
                
                let statusEnAttente = 'pending', iconEnAttente = '‚óã';
                let statusTelecharge = 'pending', iconTelecharge = '‚óã';
                let statusTeleporte = 'pending', iconTeleporte = '‚óã';
                let statusExecute = 'pending', iconExecute = '‚óã';
                
                if (hasError) {
                    if (status === 'en_attente') {
                        statusEnAttente = 'error'; iconEnAttente = '‚úï';
                    } else if (status === 'telecharge') {
                        statusEnAttente = 'success'; iconEnAttente = '‚úì';
                        statusTelecharge = 'error'; iconTelecharge = '‚úï';
                    } else if (status === 'teleporte') {
                        statusEnAttente = 'success'; iconEnAttente = '‚úì';
                        statusTelecharge = 'success'; iconTelecharge = '‚úì';
                        statusTeleporte = 'error'; iconTeleporte = '‚úï';
                    } else if (status === 'execute') {
                        statusEnAttente = 'success'; iconEnAttente = '‚úì';
                        statusTelecharge = 'success'; iconTelecharge = '‚úì';
                        if (hasDestination || hasCustomFolder) {
                            statusTeleporte = 'success'; iconTeleporte = '‚úì';
                        }
                        statusExecute = 'error'; iconExecute = '‚úï';
                    }
                } else {
                    if (status !== 'en_attente') {
                        statusEnAttente = 'success'; iconEnAttente = '‚úì';
                    }
                    if (['telecharge', 'teleporte', 'execute'].includes(status)) {
                        statusTelecharge = 'success'; iconTelecharge = '‚úì';
                    }
                    if (['teleporte', 'execute'].includes(status)) {
                        statusTeleporte = 'success'; iconTeleporte = '‚úì';
                    }
                    if (status === 'execute') {
                        statusExecute = 'success'; iconExecute = '‚úì';
                    }
                }
                
                let errorDisplay = '';
                if (hasError) {
                    errorDisplay = `<div class="error-message"><strong>‚ùå Erreur :</strong> ${d.error_message}</div>`;
                }

                return `
                    <div class="history-item">
                        <div class="folder-section">
                            <div class="folder-icon">üìÅ</div>
                            <div class="status-column">
                                <div class="status-line ${statusEnAttente}">${iconEnAttente} En attente</div>
                                <div class="status-line ${statusTelecharge}">${iconTelecharge} T√©l√©charg√©</div>
                                ${(hasDestination || hasCustomFolder) ? `<div class="status-line ${statusTeleporte}">${iconTeleporte} Plac√©</div>` : ''}
                                <div class="status-line ${statusExecute}">${iconExecute} Ex√©cut√©</div>
                            </div>
                        </div>
                        <div class="file-info">
                            <div class="target-code-info">üéØ Code: ${d.target_code}</div>
                            <div class="file-name">${d.filename || 'Fichier sans nom'}</div>
                            <div class="execution-info">Ex√©cute: ${d.file_to_execute || 'N/A'}</div>
                            <div class="destination-info">üìÇ ${fullPath}</div>
                            ${errorDisplay}
                        </div>
                        <button class="btn-delete-file" onclick="deleteFile(${d.id})">‚úï</button>
                    </div>
                `;
            });
            
            container.innerHTML = items.filter(Boolean).join('');
        }

        async function deleteFile(id) {
            if (!confirm('Supprimer ce fichier ?')) return;

            try {
                const response = await fetch(JOBS_URL + '?id=eq.' + id, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${SUPABASE_KEY}`,
                        "apikey": SUPABASE_KEY
                    }
                });

                if (response.ok) {
                    loadHistory();
                }
            } catch (error) {
                console.error("Erreur suppression:", error);
            }
        }

        // DEMARRAGE
        loadHistory();
        setInterval(loadHistory, 3000);
    </script>
</body>
</html>
